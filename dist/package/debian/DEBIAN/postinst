#!/bin/bash

set -e

exe() {
    echo "\$ $@" ; "$@" ; 
    if [ $? -ne 0 ]; then
        echo "$@ failed with exit code $?"
        exit 0
    fi
}

exe2() {
    echo "\$ $@" ; "$@" ; 
}


INSTALL_PKG_DIR="/usr/local/webida/"

# create webida user
if id -u webida >/dev/null 2>&1; then
    echo "user already exists"
else
    echo "user does not exist"
    echo "creating webida user..."
    sudo adduser --uid 2000 webida
fi

# prepare storage for app and user file system
sudo mkdir -p /var/webida/apps
sudo mkdir -p /var/webida/fs
sudo mkdir -p /var/webida/log

#cp /routingTable.json /var/webida/routingTable.json

# change owner of above directories and files to webida user and group

sudo chown webida.webida /var/webida/apps
sudo chown webida.webida /var/webida/fs
sudo chown webida.webida /var/webida/log
#sudo chown webida.webida /var/webida/routingTable.json


function unpac {
    cd $1    
    echo "current dir : " $PWD
    exe2 sudo pac install 
    exe2 npm rebuild
}


# unpac servers
unpac $INSTALL_PKG_DIR/server/server-auth
unpac $INSTALL_PKG_DIR/server/server-fs
unpac $INSTALL_PKG_DIR/server/server
unpac $INSTALL_PKG_DIR/server/notify-server
unpac $INSTALL_PKG_DIR/server/build-server
unpac $INSTALL_PKG_DIR/server/build-jm-server
unpac $INSTALL_PKG_DIR/server/server-proxy

#unpac system apps
function unpac_sysapps {
    local SYSAPP_DIR=$INSTALL_PKG_DIR/server/server/systemapps
    for f in `ls $SYSAPP_DIR`; do
        echo "File -> $f"
        local APPDIR=$SYSAPP_DIR/$f
        echo "$APPDIR is unpac..ing"
        exe unpac $APPDIR
    done
}

unpac_sysapps

chown -R webida:webida $INSTALL_PKG_DIR


# setup auth server
exe cd $INSTALL_PKG_DIR/server/server-auth
sudo npm run-script install-server

# setup rootfs for lxc. This assume that lxc is previousely installed.
exe cd $INSTALL_PKG_DIR/server/server-fs/lxc
exe sudo tar zxf rootfs.tar.gz
exe2 sudo mkdir -p $INSTALL_PKG_DIR/server/server-fs/fs
exe2 sudo chown -R webida.webida $INSTALL_PKG_DIR/server/server-fs/fs


# setup system apps
exe cd $INSTALL_PKG_DIR/server/server
exe sudo node install-offline.js
exe2 mv $INSTALL_PKG_DIR/server/server/apps/app-uip $INSTALL_PKG_DIR/server/server/apps/tmp
exe2 cp -rf $INSTALL_PKG_DIR/server/server/apps/tmp/src $INSTALL_PKG_DIR/server/server/apps/app-uip


chown -R webida:webida $INSTALL_PKG_DIR

# Stop services
exe sudo $INSTALL_PKG_DIR/bin/uip-stop-all.sh


# Start services
exe sudo $INSTALL_PKG_DIR/bin/uip-start-all.sh

echo "webida server installation is successfully done."Â 



